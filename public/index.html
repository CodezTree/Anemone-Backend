<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <!--<meta name="viewport" content="width=device-width, initial-scale=1.0" />-->
        <meta
            name="viewport"
            content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
        <title>Animon</title>
        <link rel="stylesheet" href="./styles/font.css" />
        <style>
            :root {
                --arrow-bg: rgba(255, 255, 255, 0.3);
                --arrow-icon: url(https://upload.wikimedia.org/wikipedia/commons/9/9d/Caret_down_font_awesome_whitevariation.svg);
                --option-bg: white;
                --select-bg: rgba(255, 255, 255, 0.2);
            }

            html {
                -ms-touch-action: manipulation;
                touch-action: manipulation;
            }

            button,
            input[type="button"],
            input[type="submit"] {
                -webkit-user-select: none; /* Chrome, Safari, Opera */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                user-select: none; /* Non-prefixed version, currently supported by most browsers */
                -webkit-tap-highlight-color: transparent; /* Removes highlight on tap in mobile browsers */
            }

            /* Ïä§ÌÉÄÏùº Î∂ÄÎ∂ÑÏùÄ Í∏∞Ï°¥Í≥º ÎèôÏùºÌï©ÎãàÎã§. */
            body {
                font-family: Arial, sans-serif;
                background-color: #ffffff;
                background-image: url("background_new.jpeg");
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-attachment: fixed;
                color: #333;
                display: flex;
                flex-direction: column;
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden;
                justify-content: center;
                align-items: center;
            }

            h1 {
                margin-bottom: 10px;
                color: #000000;
                text-align: center;
            }

            form {
                margin-bottom: 20px;
            }

            input[type="text"] {
                padding: 10px;
                border: 1px solid #bdc3c7;
                border-radius: 5px;
                margin-right: 10px;
                width: 200px;
            }

            button {
                padding: 10px 12px;
                background-color: #e4a565;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s ease;
                width: 115px; /* Î≤ÑÌäº ÎÑàÎπÑÎ•º Í∑†ÏùºÌïòÍ≤å ÏÑ§Ï†ï */
                box-sizing: border-box; /* Ìå®Îî©Í≥º Î≥¥ÎçîÎ•º ÎÑàÎπÑÏóê Ìè¨Ìï® */
            }

            button:hover {
                background-color: #de9d5c;
            }

            #animalContainer {
                display: none;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .user-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }

            .user-counter {
                margin-bottom: 2px;
                font-size: x-large;
                font-weight: bolder;
                color: #2c3e50;
            }

            .user-box {
                display: flex;
                flex-direction: column;
                align-items: center;
                border: 0px;
                border-radius: 0.8rem;
                margin: 0.5rem;
                padding: 6px;
                width: 5.7rem;
                text-align: center;
                background-color: #404858;
                /*background-image: url("namecard_back.png");*/
                background-size: cover;
                background-position-x: 25%;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .animal-image {
                width: 5.5rem;
                height: 5.5rem;
                border-radius: 3.9rem;
            }

            .expression-buttons {
                display: flex;
                margin-top: 20px;
            }

            .expression-buttons button,
            .mic-button button {
                margin: 5px;
                flex-grow: 1;
            }

            .tool-buttons {
                display: flex;
                margin-top: 5px;
            }

            .mic-button {
                display: flex;
                justify-content: center;
            }

            .ready-button {
                display: flex;
                justify-content: center;
            }

            .ready-button button {
                margin: 5px;
            }

            .handson-button {
                display: none;
                justify-content: center;
            }

            .handson-button button {
                margin: 5px;
            }

            .ready-status {
                margin-top: 2px;
                margin-bottom: 2px;
                margin-right: 4px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .ready-status img {
                width: 16px;
                height: 16px;
                vertical-align: middle;
            }

            .mic-status {
                margin-top: 2px;
                margin-bottom: 2px;
                margin-left: 4px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .mic-status img {
                width: 16px;
                height: 16px;
                padding: 0px;
                vertical-align: middle;
            }

            .status-box {
                background-color: white;
                border-radius: 10px;
                display: flex;
                flex-direction: row;
                margin-top: 4px;
                gap: 4px;
            }

            .me-handson {
                display: none; /* Ï≤òÏùåÏóêÎäî none */
                margin-top: 4px;
                margin-bottom: 4px;
                margin-right: 6px;
                font-size: 16px;
                justify-content: center;
                align-items: center;
                width: 16px;
                height: 16px;
            }

            @keyframes wave {
                0% {
                    transform: rotate(-30deg);
                    animation-timing-function: ease-in;
                }
                25% {
                    transform: rotate(0deg);
                    animation-timing-function: ease-out;
                }
                50% {
                    transform: rotate(30deg);
                    animation-timing-function: ease-in;
                }
                75% {
                    transform: rotate(0deg);
                    animation-timing-function: ease-out;
                }
                100% {
                    transform: rotate(-30deg);
                }
            }

            .waving-hand {
                display: inline-block;
                animation: wave 1.5s infinite;
                transform-origin: 50% 90%; /* ÏÜêÎ™©Ïù¥ ÌùîÎì§Î¶¨ÎèÑÎ°ù ÌöåÏ†Ñ Ï§ëÏã¨ Ï°∞Ï†ï */
                font-size: 1.3rem; /* ÏÜê ÌÅ¨Í∏∞ */
            }

            .turn-skipbutton {
                display: none;
            }

            .interested-button {
                display: none;
            }

            .name-box {
                margin-top: 4px;
                margin-bottom: 0px;
                background-color: #00000000;
                border-radius: 0.2rem;
                padding: 2px;
                padding-left: 5px;
                padding-right: 5px;
                margin-left: 10px;
                margin-right: 10px;
                width: 80px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: clip;
                color: white;
            }

            .speaker-tool {
                display: none;
                flex-direction: row;
                width: fit-content;
                justify-content: center;
                align-items: center;
                height: 36px;
            }

            .timer-box {
                background-color: white;
                border-radius: 0.2rem;
                border: 1px solid black;
                padding: 7px;
                padding-left: 40px;
                padding-right: 40px;
                font-size: medium;
                text-align: center;
                margin-bottom: 10px;
                display: block; /* TODO : check hidden */
            }

            .notice-box {
                margin-top: 4px;
                margin-bottom: 2px;
                font-size: x-large;
                font-weight: bolder;
                color: #ff6666;
                background-color: white;
                padding: 3px 7px 3px 7px;
                border-radius: 0.2rem;
            }

            .app-box {
                padding: 5px;
                background-color: white;
                width: 100vw;
                height: 100vh;

                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-attachment: fixed;
            }

            .intro-container {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100%;
            }

            .room-selection-container {
                display: none;
                flex-direction: column;
                gap: 4px;
                padding: 8px;
            }

            .room-listups {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border: 2px solid #000000;
                border-radius: 4px;
            }

            .room-listups .room-topic {
                font-size: larger;
            }

            .room-subroom-list {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                padding: 10px;
                gap: 4px;
                color: #000000;
            }

            .room-item {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                width: min-content;
                border: 1px solid #000000;
                border-radius: 4px;
                padding: 8px;
            }

            .intro-form {
                display: none;
                flex-direction: column;
                flex-wrap: nowrap;
                align-items: center;
                gap: 10px;
            }

            .room-code-form {
                display: none;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .transparent-box {
                border: 1px solid #abc8db;
                border-radius: 25px;
                padding: 8px;
                margin: 10px;
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                box-shadow: 2px 7px 15px 8px rgba(0, 0, 0, 0.3);
            }

            button.pick-button {
                visibility: hidden;
                padding: 0px;
                padding-top: 7px;
                padding-bottom: 3px;
                margin-top: 4px;
                border-radius: 10px;
                width: 5.5rem;
                box-sizing: content-box;
            }

            select {
                /* Reset */
                appearance: none;
                border: 0;
                outline: 0;
                font: inherit;
                /* Personalize */
                width: 10rem;
                padding: 0.5rem 2rem 0.5rem 2rem;
                background: var(--arrow-icon) no-repeat right 0.8em center /
                        1.4em,
                    linear-gradient(
                        to left,
                        var(--arrow-bg) 3em,
                        var(--select-bg) 3em
                    );
                color: black;
                border-radius: 0.25em;
                box-shadow: 0 0 1em 0 rgba(0, 0, 0, 0.2);
                cursor: pointer;
                /* Remove IE arrow */
                &::-ms-expand {
                    display: none;
                }
                /* Remove focus outline */
                &:focus {
                    outline: none;
                }
                /* <option> colors */
                option {
                    color: inherit;
                    background-color: var(--option-bg);
                }
            }

            .form__group {
                position: relative;
                padding: 15px 0 0;
                margin-top: 10px;
                width: 50%;
            }

            .form__field {
                font-family: inherit;
                width: 100%;
                border: 0;
                border-bottom: 2px solid black;
                outline: 0;
                font-size: 1.3rem;
                color: black;
                padding: 7px 0;
                background: transparent;
                transition: border-color 0.2s;

                &::placeholder {
                    color: transparent;
                }

                &:placeholder-shown ~ .form__label {
                    font-size: 1.3rem;
                    cursor: text;
                    top: 20px;
                }
            }

            .form__label {
                position: absolute;
                top: 0;
                display: block;
                transition: 0.2s;
                font-size: 1rem;
                color: black;
            }

            .form__field:focus {
                ~ .form__label {
                    position: absolute;
                    top: 0;
                    display: block;
                    transition: 0.2s;
                    font-size: 1rem;
                    color: #ff9c22;
                    font-weight: 700;
                }
                padding-bottom: 6px;
                font-weight: 700;
                border-width: 3px;
                border-image: linear-gradient(to right, #ff9c22, #dacfc4);
                border-image-slice: 1;
            }
            /* reset input */
            .form__field {
                &:required,
                &:invalid {
                    box-shadow: none;
                }
            }

            /* --------- Chat System ---------*/
            /* Floating Button */
            .chat-float-btn {
                display: none;
                position: fixed;
                right: 20px;
                bottom: 20px;
                background-color: #e4a565;
                color: white;
                padding: 15px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 24px;
                width: 2rem;
                height: 2rem;
                text-align: center;
                justify-content: center;
                box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            }

            /* Notification Badge */
            .chat-notification {
                position: absolute;
                top: 0px;
                right: 0px;
                background-color: red;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
            }

            /* Chat Popup Window */
            .chat-popup {
                position: fixed;
                bottom: -600px;
                right: 20px;
                width: 300px;
                background-color: white;
                border: 1px solid #e2872d;
                box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
                border-radius: 10px;
                transition: bottom 0.3s;
                text-align: center;
                justify-content: center;
            }

            /* Chat Header */
            .chat-header {
                padding: 10px;
                background-color: #e4a565;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
                height: 2rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .chat-header button {
                flex-basis: content;
                font-size: medium;
                color: white;
            }

            .chat-header h4 {
                margin-left: 0.3rem;
                color: white;
            }

            /* Chat Body */
            .chat-body {
                max-height: 400px;
                min-height: 200px;
                overflow-y: auto;
                padding: 10px;
                background-color: #ffffff;
            }

            /* Chat Input */
            .chat-input {
                display: flex;
                border-top: 1px solid #ccc;
            }

            .chat-input input {
                flex-grow: 1;
                padding: 10px;
                border: none;
                border-bottom-left-radius: 10px;
            }

            .chat-input button {
                padding: 10px;
                background-color: #e4a565;
                color: white;
                border: none;
                border-bottom-right-radius: 10px;
                cursor: pointer;
            }

            .messageElement {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            /* --------- Chat System Ends ---------*/
        </style>
    </head>
    <body>
        <div id="transparentBox" class="transparent-box">
            <!--<div id="appBox" class="app-box">-->
            <div id="introContainer" class="intro-container">
                <img
                    src="./animon_logo.jpeg"
                    alt="App logo"
                    style="width: 200px" />
                <p
                    class="poppins-bold"
                    style="
                        font-size: 40px;
                        margin-top: 2px;
                        margin-bottom: 2px;
                    ">
                    ANIMON
                </p>
            </div>
            <form id="nameForm" class="intro-form">
                <img
                    src="images/intro.jpeg"
                    width="400px"
                    style="border-radius: 30px" />

                <div class="form__group field" style="margin-bottom: 5px">
                    <input
                        type="input"
                        id="userName"
                        name="userName"
                        class="form__field"
                        placeholder="Enter Your Name"
                        required />
                    <label for="userName" class="form__label">Name</label>
                </div>

                <select id="animalChoice">
                    <option value="dog">Dog</option>
                    <option value="cat">Cat</option>
                    <option value="squirrel">Squirrel</option>
                    <option value="fox">Fox</option>
                    <option value="panda">Panda</option>
                </select>
                <button type="submit">Join</button>
            </form>
            <form id="roomForm" class="room-code-form">
                <img
                    src="images/intro.jpeg"
                    width="400px"
                    style="border-radius: 30px" />

                <div class="form__group field" style="margin-bottom: 5px">
                    <input
                        type="input"
                        id="roomCode"
                        name="roomCode"
                        class="form__field"
                        placeholder="Enter Room Code"
                        required />
                    <label for="roomCode" class="form__label">Room Code</label>
                </div>
                <button type="submit">Join Room</button>
            </form>
            <div id="roomSelectionContainer" class="room-selection-container">
                <button id="roomRefresh" onclick="requestRoomStatus()">
                    Refresh
                </button>
                <div id="roomListUps" class="room-listups">
                    <p class="room-topic">Coming Out Before</p>
                    <div class="room-subroom-list">
                        <div id="room1" class="room-item">
                            <p id="roomP_1" class="room-people">0/5</p>
                            <button
                                id="joinButton1"
                                class="join-button"
                                onclick="joinRoom1()">
                                JOIN
                            </button>
                        </div>
                        <div id="room2" class="room-item">
                            <p id="roomP_2" class="room-people">0/5</p>
                            <button
                                id="joinButton2"
                                class="join-button"
                                onclick="joinRoom2()">
                                JOIN
                            </button>
                        </div>
                        <div id="room3" class="room-item">
                            <p id="roomP_3" class="room-people">0/5</p>
                            <button
                                id="joinButton3"
                                class="join-button"
                                onclick="joinRoom3()">
                                JOIN
                            </button>
                        </div>
                        <div id="room4" class="room-item">
                            <p id="roomP_4" class="room-people">0/5</p>
                            <button
                                id="joinButton4"
                                class="join-button"
                                onclick="joinRoom4()">
                                JOIN
                            </button>
                        </div>
                    </div>
                </div>

                <div id="roomListUps" class="room-listups">
                    <p class="room-topic">Coming Out After</p>
                    <div class="room-subroom-list">
                        <div id="room5" class="room-item">
                            <p id="roomP_5" class="room-people">0/5</p>
                            <button
                                id="joinButton5"
                                class="join-button"
                                onclick="joinRoom5()">
                                JOIN
                            </button>
                        </div>
                        <div id="room6" class="room-item">
                            <p id="roomP_6" class="room-people">0/5</p>
                            <button
                                id="joinButton6"
                                class="join-button"
                                onclick="joinRoom6()">
                                JOIN
                            </button>
                        </div>
                        <div id="room7" class="room-item">
                            <p id="roomP_7" class="room-people">0/5</p>
                            <button
                                id="joinButton7"
                                class="join-button"
                                onclick="joinRoom7()">
                                JOIN
                            </button>
                        </div>
                        <div id="room8" class="room-item">
                            <p id="roomP_8" class="room-people">0/5</p>
                            <button
                                id="joinButton8"
                                class="join-button"
                                onclick="joinRoom8()">
                                JOIN
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="animalContainer">
                <div id="noticeBox" class="notice-box">TOPIC</div>
                <div id="timerBox" class="timer-box">
                    ‚è≥ <b>03:00</b><br />üì£ <b>NOT STARTED</b>
                </div>

                <div id="userCounter" class="user-counter">1 / 5</div>
                <div class="speaker-tool" id="speakerTool">
                    <button
                        id="turnSkipButton"
                        class="turn-skipbutton"
                        onclick="turnSkip()">
                        SKIP TURN
                    </button>
                    <button
                        id="interestedButton"
                        class="interested-button"
                        onclick="interstedSpeak()">
                        ‚ù§Ô∏è MORE!
                    </button>
                </div>

                <div id="userContainer" class="user-container"></div>
                <div class="expression-buttons">
                    <button onclick="changeExpression('happy')">
                        üòä Happy
                    </button>
                    <button onclick="changeExpression('sad')">üò¢ Sad</button>
                    <button onclick="changeExpression('surprised')">
                        üò≤ Surprised
                    </button>
                </div>
                <div class="tool-buttons">
                    <div class="mic-button">
                        <button onclick="toggleMic()" id="micButton">
                            üé§ Toggle Mic
                        </button>
                    </div>
                    <div id="readyButton" class="ready-button">
                        <button onclick="toggleReady()">‚úÖ Ready</button>
                    </div>
                    <div id="handsonButton" class="handson-button">
                        <button onclick="handsOnSign()">‚úã Have Idea</button>
                    </div>
                </div>
            </div>
        </div>
        <!--</div>-->

        <!-- Floating Button -->
        <div
            id="chatFloatButton"
            class="chat-float-btn"
            onclick="toggleChatWindow()"
            style="
                -webkit-user-select: none; /* Chrome, Safari, Opera */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                user-select: none; /* Non-prefixed version, currently supported by most browsers */
                -webkit-tap-highlight-color: transparent;
            ">
            üí¨
            <div
                class="chat-notification"
                id="chatNotification"
                style="display: none">
                0
            </div>
        </div>

        <!-- Chat Popup Window -->
        <div class="chat-popup" id="chatPopup">
            <div class="chat-header">
                <h4>Room Chat</h4>
                <button onclick="toggleChatWindow()">‚úñ</button>
            </div>
            <div class="chat-body" id="chatBody">
                <!-- Messages will be appended here -->
            </div>
            <div class="chat-input">
                <input
                    type="text"
                    id="chatInput"
                    placeholder="Type a message..." />
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- Sound Effect -->
        <audio id="dingAudio" src="./sounds/ding_sound.mp3"></audio>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();

            const appBox = document.getElementById("appBox");

            const nameForm = document.getElementById("nameForm");
            const roomForm = document.getElementById("roomForm");

            // Container
            const introContainer = document.getElementById("introContainer");
            const animalContainer = document.getElementById("animalContainer");
            const userContainer = document.getElementById("userContainer");

            const userCounter = document.getElementById("userCounter");
            const noticeBox = document.getElementById("noticeBox");
            const chatFloatButton = document.getElementById("chatFloatButton");
            const chatPopup = document.getElementById("chatPopup");
            // const titleBox = document.getElementById("titleBox");
            const timerBox = document.getElementById("timerBox");
            const handsOnButton = document.getElementById("handsonButton");
            const readyButton = document.getElementById("readyButton");
            const micButton = document.getElementById("micButton");
            const turnSkipButton = document.getElementById("turnSkipButton");
            const interestedButton =
                document.getElementById("interestedButton");
            const speakerTool = document.getElementById("speakerTool");
            const roomSelectionContainer = document.getElementById(
                "roomSelectionContainer"
            );

            // Room people yeah
            const roomP_1 = document.getElementById("roomP_1");
            const roomP_2 = document.getElementById("roomP_2");
            const roomP_3 = document.getElementById("roomP_3");
            const roomP_4 = document.getElementById("roomP_4");
            const roomP_5 = document.getElementById("roomP_5");
            const roomP_6 = document.getElementById("roomP_6");
            const roomP_7 = document.getElementById("roomP_7");
            const roomP_8 = document.getElementById("roomP_8");

            // Join button yeah
            const joinButton1 = document.getElementById("joinButton1");
            const joinButton2 = document.getElementById("joinButton2");
            const joinButton3 = document.getElementById("joinButton3");
            const joinButton4 = document.getElementById("joinButton4");
            const joinButton5 = document.getElementById("joinButton5");
            const joinButton6 = document.getElementById("joinButton6");
            const joinButton7 = document.getElementById("joinButton7");
            const joinButton8 = document.getElementById("joinButton8");

            let isMicOn = false;
            let roomCode = null;
            let userName = "";
            let timeoutId = null;
            let handsOnTimeoutId = null;
            let localStream = null;
            let onFrameId = null;
            let onFrame;
            let userCount = 0;
            let selectedAnimal = "dog"; // Í∏∞Î≥∏ Í∞íÏúºÎ°ú ÏÑ§Ï†ï
            let unmutable = true;
            let sessionStarted = false;
            let currentSpeakerId = undefined;
            let handsOn = false;
            let interestCount = 0;
            let refreshInterval;

            const minimumUser = 3;

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§ÌñâÎê† ÏΩîÎìú
            window.onload = function () {
                const animalSelect = document.getElementById("animalChoice");
                const options = animalSelect.options;
                const randomIndex = Math.floor(Math.random() * options.length);
                animalSelect.selectedIndex = randomIndex; // ÎûúÎç§ÌïòÍ≤å ÏÑ†ÌÉùÎêú ÏòµÏÖò Ïù∏Îç±Ïä§Î•º ÏÑ§Ï†ï
            };

            // Î∞© ÏÉàÎ°úÍ≥†Ïπ®
            refreshInterval = setInterval(() => {
                requestRoomStatus();
            }, 5000);

            // Î∞© ÏãúÏûë Ï§ÄÎπÑ ÌôïÏù∏
            let isReady = false;

            const peerConnections = {};
            const config = {
                iceServers: [
                    { urls: "stun:stun.l.google.com:19302" },
                    { urls: "stun:stun.l.google.com:5349" },
                    { urls: "stun:stun1.l.google.com:3478" },
                    { urls: "stun:stun1.l.google.com:5349" },
                    { urls: "stun:stun2.l.google.com:19302" },
                    { urls: "stun:stun2.l.google.com:5349" },
                    {
                        urls: "turn:141.164.63.143",
                        username: "animon",
                        credential: "animon",
                    },
                ],
            };

            // ÎèôÎ¨º Î¶¨Ïä§Ìä∏
            const animalImages = {
                dog: {
                    neutral: "images/dog_neutral.png",
                    happy: "images/dog_happy.png",
                    sad: "images/dog_sad.png",
                    surprised: "images/dog_surprised.png",
                    talk: "images/dog_talk.png",
                },
                cat: {
                    neutral: "images/cat_neutral.png",
                    happy: "images/cat_happy.png",
                    sad: "images/cat_sad.png",
                    surprised: "images/cat_surprised.png",
                    talk: "images/cat_talk.png",
                },
                squirrel: {
                    neutral: "images/squirrel_neutral.png",
                    happy: "images/squirrel_happy.png",
                    sad: "images/squirrel_sad.png",
                    surprised: "images/squirrel_surprised.png",
                    talk: "images/squirrel_talk.png",
                },
                fox: {
                    neutral: "images/fox_neutral.png",
                    happy: "images/fox_happy.png",
                    sad: "images/fox_sad.png",
                    surprised: "images/fox_surprised.png",
                    talk: "images/fox_talk.png",
                },
                panda: {
                    neutral: "images/panda_neutral.png",
                    happy: "images/panda_happy.png",
                    sad: "images/panda_sad.png",
                    surprised: "images/panda_surprised.png",
                    talk: "images/panda_talk.png",
                },
            };

            // ------ STARTUP ------
            logoLoad();
            // ---- STARTUP ENDS ----

            nameForm.addEventListener("submit", (e) => {
                e.preventDefault();
                userName = document.getElementById("userName").value;
                selectedAnimal = document.getElementById("animalChoice").value; // ÏÑ†ÌÉùÎêú ÎèôÎ¨º Ï†ÄÏû•
                nameForm.style.display = "none";
                roomSelectionContainer.style.display = "flex";
                //roomForm.style.display = "flex";
            });

            // roomForm.addEventListener("submit", (e) => {
            //     e.preventDefault();
            //     roomCode = document.getElementById("roomCode").value;
            //     tryJoinRoom(roomCode);
            // });

            function tryJoinRoom(roomCode) {
                socket.emit("tryJoin", roomCode);
            }

            socket.on("roomFull", () => {
                alert("Room is full!");
                enableAllJoinButton();
                requestRoomStatus();
            });

            socket.on("roomAlreadyStarted", () => {
                alert("Room session already started!");
                enableAllJoinButton();
                requestRoomStatus();
            });

            socket.on("joinOK", (_roomCode) => {
                // Î£∏ÏΩîÎìú ÏÑ§Ï†ï
                roomCode = _roomCode;
                joinRoom(_roomCode);
                clearInterval(refreshInterval);
            });

            socket.on("roomStatus", ({ r1, r2, r3, r4, r5, r6, r7, r8 }) => {
                roomP_1.innerText = r1 == 8 ? "STARTED" : r1 + "/5";
                roomP_2.innerText = r2 == 8 ? "STARTED" : r2 + "/5";
                roomP_3.innerText = r3 == 8 ? "STARTED" : r3 + "/5";
                roomP_4.innerText = r4 == 8 ? "STARTED" : r4 + "/5";
                roomP_5.innerText = r5 == 8 ? "STARTED" : r5 + "/5";
                roomP_6.innerText = r6 == 8 ? "STARTED" : r6 + "/5";
                roomP_7.innerText = r7 == 8 ? "STARTED" : r7 + "/5";
                roomP_8.innerText = r8 == 8 ? "STARTED" : r8 + "/5";
            });

            async function joinRoom(roomCode) {
                console.log("Accessing media...");
                // ÎßàÏù¥ÌÅ¨ Ïä§Ìä∏Î¶º ÏÑ§Ï†ï
                await navigator.mediaDevices
                    .getUserMedia({ audio: true })
                    .then((stream) => {
                        localStream = stream; // Î°úÏª¨ Ïä§Ìä∏Î¶º Ï†ÄÏû•
                        console.log("Local stream obtained");

                        // Ìä∏Îûô ÎπÑÌôúÏÑ±Ìôî
                        localStream.getAudioTracks().forEach((track) => {
                            track.enabled = false;
                        });

                        // ÎßàÏù¥ÌÅ¨ Ïù∏Ìíã Ï∏°Ï†ï
                        const context = new AudioContext();
                        const analyzer = context.createAnalyser();
                        const mediaStreamAudioStreamSource =
                            context.createMediaStreamSource(stream);
                        mediaStreamAudioStreamSource.connect(analyzer, 0);
                        const pcmData = new Float32Array(analyzer.fftSize);

                        // register anim
                        onFrame = () => {
                            analyzer.getFloatTimeDomainData(pcmData);
                            let sum = 0.0;
                            for (const amplitude of pcmData) {
                                sum += amplitude * amplitude;
                            }
                            const rms = Math.sqrt(sum / pcmData.length);
                            const normalizedVolume = Math.min(1, rms / 0.5);
                            changeVolumeColor(normalizedVolume * 10);
                            onFrameId = window.requestAnimationFrame(onFrame);
                        };

                        onFrameId = window.requestAnimationFrame(onFrame);
                    })
                    .catch((error) => {
                        console.error("Error accessing media devices.", error);
                    });

                //Î£∏ Ï°∞Ïù∏
                socket.emit("joinRoom", {
                    roomCode,
                    userName,
                    animal: selectedAnimal,
                });

                // ÌïÑÏöîÌïú element display / none
                //roomForm.style.display = "none";
                roomSelectionContainer.style.display = "none";
                chatFloatButton.style.display = "block";
                //titleBox.style.display = "none";
                animalContainer.style.display = "flex";

                // background image Î≥ÄÍ≤Ω
                //appBox.style.backgroundImage = "./background_new.jpeg";

                socket.off("existingUsers");
                socket.off("userJoined");
                socket.off("userLeft");
                socket.off("changeExpression");
                socket.off("toggleMic");
                socket.off("toggleReady");
                socket.off("syncState");
                socket.off("offer");
                socket.off("answer");
                socket.off("candidate");
                socket.off("startSession");
                socket.off("roomMessage");
                socket.off("sessionStarted");
                socket.off("updateSpeaker");
                socket.off("updateTimer");
                socket.off("sessionEnded");
                socket.off("pickButtonDisable");
                socket.off("roomDestroyed");
                socket.off("handsOnSign");
                socket.off("speakExtended");

                console.log("My socket id : " + socket.id);

                socket.on("adminNotice", (notice_string) => {
                    noticeBox.innerText = "NOTICE : " + notice_string;
                });

                socket.on("existingUsers", (users) => {
                    users.forEach((user) => {
                        addUser(
                            user.userId,
                            user.userName,
                            user.isMicOn,
                            user.animal
                        );
                        userCount++;
                    });
                    updateUserCounter();
                });

                socket.on("userJoined", (data) => {
                    if (data.userId == socket.id) {
                        console.log("user join conflict!");
                        return;
                    }

                    console.log(
                        "\n" +
                            data.userId +
                            " joined room " +
                            data.roomCode +
                            "!! \n\n"
                    );
                    addUser(
                        data.userId,
                        data.userName,
                        data.isMicOn,
                        data.animal
                    );
                    createOffer(data.userId);
                    syncState(data.userId);

                    userCount++;
                    updateUserCounter();
                });

                socket.on("userLeft", (data) => {
                    removeUser(data.userId);
                    closePeerConnection(data.userId);

                    console.log("User " + data.userId + " left voice room.");
                    userCount--;
                    updateUserCounter();
                });

                socket.on("changeExpression", (data) => {
                    updateExpression(data);
                });

                socket.on("toggleMic", (data) => {
                    const userBox = document.getElementById(data.userId);
                    if (userBox) {
                        const micStatus = userBox.querySelector(".mic-status");
                        micStatus.innerHTML = `<img src="${
                            data.isMicOn ? "mic_on.png" : "mic_off.png"
                        }" alt="Mic Status">`;
                    }
                    console.log(
                        `Mic for user ${data.userId} is ${
                            data.isMicOn ? "on" : "off"
                        }`
                    );
                });

                socket.on("toggleReady", (data) => {
                    const userBox = document.getElementById(data.userId);
                    if (userBox) {
                        const readyStatus =
                            userBox.querySelector(".ready-status");
                        readyStatus.innerHTML = `<img src="${
                            data.isReady
                                ? "icons/checkIcon.png"
                                : "icons/notcheckIcon.png"
                        }" alt="Ready Status">`;
                    }
                    console.log(
                        `Ready for user ${data.userId} is ${
                            data.isReady ? "ready" : "not ready"
                        }`
                    );
                });

                socket.on("offer", (data) => {
                    console.log("Recieve offer from.." + data.from);
                    createAnswer(data);
                });

                socket.on("answer", (data) => {
                    console.log("Recieve answer from.." + data.from);
                    if (peerConnections[data.from]) {
                        if (data.from == socket.id) {
                            console.log("Anwser self conflict!");
                            return;
                        }

                        peerConnections[data.from]
                            .setRemoteDescription(
                                new RTCSessionDescription(data.answer)
                            )
                            .catch((error) => {
                                console.error(
                                    "Error setting remote description for answer: ",
                                    error
                                );
                            });

                        console.log(
                            "Registering answer => from : " +
                                data.from +
                                " to : "
                        );
                        console.log(data.answer);
                    }
                });

                socket.on("candidate", (data) => {
                    const candidate = new RTCIceCandidate(data.candidate);
                    if (peerConnections[data.from]) {
                        console.log(
                            "Got candidate from " +
                                data.from +
                                " ... Registering."
                        );
                        peerConnections[data.from].addIceCandidate(candidate);
                    }
                });

                socket.on("syncState", (data) => {
                    console.log(
                        "Sync from other user (" + data.from + " starts."
                    );

                    const userBox = document.getElementById(data.from);
                    if (userBox) {
                        // Sync Mic Status
                        const micStatus = userBox.querySelector(".mic-status");
                        micStatus.innerHTML = `<img src="${
                            data.isMicOn ? "mic_on.png" : "mic_off.png"
                        }" alt="Mic Status">`;

                        // Sync Ready Status
                        const readyStatus =
                            userBox.querySelector(".ready-status");
                        readyStatus.innerHTML = `<img src="${
                            data.isReady
                                ? "icons/checkIcon.png"
                                : "icons/notcheckIcon.png"
                        }" alt="Ready Status">`;
                    }
                });

                socket.on("roomMessage", (data) => {
                    receiveMessage(data.message, data.userName, data.animal);
                });

                socket.on("startSession", () => {
                    // Î™®Îì† ÏÇ¨Ïö©ÏûêÎ•º ÏùåÏÜåÍ±∞ / Î∞úÏñ∏Í∂å ÏóÜÎäî ÏÇ¨Ïö©ÏûêÎèÑ
                    fixedMuteUser();
                    sessionStarted = true;

                    // UI Ìà¥ ÌôúÏÑ±Ìôî
                    speakerTool.style.display = "flex";

                    // Î∂àÌïÑÏöîÌïú UI Ïà®Í∏∞Í∏∞
                    userCounter.style.display = "none";

                    // turn skip Î≤ÑÌäº Ï§ÄÎπÑ
                    turnSkipButton.style.display = "block";

                    // ÏÜêÎì§Í∏∞ Î≤ÑÌäº & UI ÌôúÏÑ±Ìôî
                    handsOnButton.style.display = "flex";
                    const handsOnArray = Array.from(
                        document.getElementsByClassName("me-handson")
                    );
                    handsOnArray.forEach((ui) => {
                        ui.style.display = "flex";
                    });

                    // Ï§ÄÎπÑ Î≤ÑÌäº & UI ÎπÑÌôúÏÑ±Ìôî
                    readyButton.style.display = "none";
                    const readyArray = Array.from(
                        document.getElementsByClassName("ready-status")
                    );
                    readyArray.forEach((ui) => {
                        ui.style.display = "none";
                    });
                });

                socket.on("updateSpeaker", ({ speakerId, isOriginSpeaker }) => {
                    // reset interest count
                    interestCount = 0;

                    // set current speaker
                    currentSpeakerId = speakerId;

                    // Sound Effect
                    dingSoundEffect();

                    // new speaker -> vote reset
                    if (speakerId != socket.id)
                        interestedButton.style.display = "block";
                    else interestedButton.style.display = "none"; // Speaker cannot express interested

                    interestedButton.disabled = false;
                    interestedButton.innerText = "‚ù§Ô∏è MORE!";

                    // Î™®Îì† ÏÇ¨Ïö©ÏûêÎ•º ÏùåÏÜåÍ±∞ / Î∞úÏñ∏Í∂å ÏóÜÎäî ÏÇ¨Ïö©ÏûêÎèÑ
                    if (socket.id === speakerId) {
                        // ÎÇ¥Í∞Ä Î∞úÏñ∏Í∂åÏù¥ ÏûàÎã§Î©¥
                        unmutable = true;
                        micButton.innerText = "üé§ Toggle Mic";

                        // Ïä§ÌÇµÎèÑ Í∞ÄÎä•ÌïòÍ≤å
                        turnSkipButton.style.display = "block";
                        turnSkipButton.disabled = false;
                    } else {
                        fixedMuteUser();
                        micButton.innerText = "üé§ WAIT ‚ùå";

                        // Ïä§ÌÇµ Ïà®Í∏∞Í∏∞
                        turnSkipButton.style.display = "none";
                        turnSkipButton.disabled = true;
                    }
                });

                socket.on("updateTimer", ({ timeLeft, feedback, originId }) => {
                    // ÌÉÄÏù¥Î®∏ UIÎ•º ÏóÖÎç∞Ïù¥Ìä∏
                    updateTimerUI(timeLeft, feedback, interestCount);

                    if (feedback == 1) {
                        interestCount = 0; // pick time Ïùº ÎñÑÎäî Ï¢ãÏïÑÏöî Ï¥àÍ∏∞Ìôî

                        // Ïä§ÌÇµ Ïà®Í∏∞Í∏∞ - pick time
                        interestedButton.style.display = "none";
                    }

                    if (feedback == 1 && originId == socket.id) {
                        const elementsArr = Array.from(
                            document.getElementsByClassName("pick-button")
                        );

                        // feedback pick && Ï£ºÎèÑÍ∂åÏù¥ ÎÇ¥Í∫ºÏùºÎïê
                        // ÏïÑÍπå Ïä§ÌÇµÌñàÏñ¥ÎèÑ Îã§Ïãú ÌôúÏÑ±Ìôî ÏãúÏºúÏ§òÏïº Ìï®
                        turnSkipButton.disabled = false;

                        elementsArr.forEach((button) => {
                            // check handsOn
                            const handsOnElement =
                                button.parentElement.getElementsByClassName(
                                    "me-handson"
                                )[0];

                            if (
                                button.parentElement.id != socket.id &&
                                handsOnElement.innerHTML === "‚úã"
                            )
                                button.style.visibility = "visible";
                            else button.style.visibility = "hidden";
                        });
                    }
                });

                socket.on("sessionEnded", () => {
                    // ÌïÑÏöîÏóê Îî∞Îùº UIÎ•º Ï¥àÍ∏∞Ìôî
                    alert("Session has ended.");

                    // ÏûêÏú†Î°≠Í≤å ÎåÄÌôî Í∞ÄÎä•ÌïòÎèÑÎ°ù
                    unmutable = true;
                    micButton.innerText = "üé§ Toggle Mic";
                    turnSkipButton.style.visibility = "hidden";
                });

                socket.on("pickButtonDisable", () => {
                    // ÏÑ†ÌÉùÌñàÎã§Î©¥ or Îã§Ïùå ÏÇ¨ÎûåÏúºÎ°ú ÎÑòÏñ¥Í∞ÑÎã§Î©¥ Ï¥àÍ∏∞Ìôî
                    selectFeedbackButtonInvisible();
                });

                socket.on("roomDestroyed", () => {
                    alert("Room has terminated, user churned.");
                    window.location.reload();
                });

                socket.on("handsOnSign", (data) => {
                    const userBox = document.getElementById(data.userId);
                    if (userBox) {
                        const handsOn = userBox.querySelector(".me-handson");
                        handsOn.innerHTML = data.handsOn ? "‚úã" : "üò∂";

                        // waving animation
                        if (data.handsOn) {
                            handsOn.classList.add("waving-hand");
                        } else {
                            handsOn.classList.remove("waving-hand");
                        }
                    }
                });

                // ÎåÄÌôî Ïó∞Ïû• ÎêòÏóàÎã§Î©¥
                socket.on("speakExtended", () => {
                    // Ï¢ãÏïÑÏöî Ï¥àÍ∏∞Ìôî
                    interestCount = 0;

                    if (socket.id != currentSpeakerId) {
                        interestedButton.disabled = false;
                        interestedButton.innerText = "‚ù§Ô∏è MORE!";
                    }
                });

                socket.on("interestedSpeak", () => {
                    interestCount++;
                });
            }

            function interstedSpeak() {
                socket.emit("interestedSpeak", {
                    userId: socket.id,
                    roomCode: roomCode,
                });

                interestedButton.disabled = true;
                interestedButton.innerText = "‚ù§Ô∏è Extend!";
            }

            function logoLoad() {
                setTimeout(() => {
                    introContainer.style.display = "none";
                    nameForm.style.display = "flex";
                }, 1500);
            }

            // ÏûêÏã†Ïùò ÌÑ¥ÏùÑ Ïä§ÌÇµÌïúÎã§.
            function turnSkip() {
                socket.emit("turnSkip", {
                    userId: socket.id,
                    roomCode: roomCode,
                });

                turnSkipButton.disabled = true;
            }

            function selectFeedbackButtonInvisible() {
                // Î™®Îì† ÏÑ†ÌÉù Î≤ÑÌäº visibility hidden
                const elementsArr = Array.from(
                    document.getElementsByClassName("pick-button")
                );

                elementsArr.forEach((button) => {
                    button.style.visibility = "hidden";
                });
            }

            function selectFeedback(feedbackUserBox) {
                socket.emit("feedbackSelect", {
                    feedbackUserId: feedbackUserBox.id,
                    roomCode: roomCode,
                });
            }

            function updateUserCounter() {
                userCounter.innerText = userCount + " / 5";

                if (userCount < minimumUser) {
                    userCounter.style.color = "red";
                } else {
                    userCounter.style.color = "#2c3e50";
                }
            }

            function fixedMuteUser() {
                // ÎßàÏù¥ÌÅ¨ ÏºúÏ†∏ ÏûàÎã§Î©¥ ÎÅÑÍ∏∞
                if (isMicOn) {
                    toggleMic();
                }

                unmutable = false;
            }

            function updateTimerUI(timeLeft, feedback, interestCount) {
                const minute = Math.floor(timeLeft / 60);
                const second = timeLeft % 60;

                const speakerName = document
                    .getElementById(currentSpeakerId)
                    .querySelector(".name-box").innerText;

                let currentPartIndicator = "";
                switch (feedback) {
                    case 0:
                        currentPartIndicator = "üéôÔ∏è";
                        break;
                    case 1:
                        currentPartIndicator = "ü§î";
                        break;
                    case 2:
                        currentPartIndicator = "üí≠";
                        break;
                }

                timerBox.innerHTML = `‚è≥ <b>0${minute}:${
                    second < 10 ? "0" + second : second
                }</b><br />${currentPartIndicator} <b>${speakerName}</b> / ‚ù§Ô∏è ${interestCount}`;
            }

            function changeVolumeColor(vol, id = socket.id) {
                //console.log("Changing volume color base on => " + vol);

                const VOL_METER_MAX = 10;
                const user_box = document.getElementById(id);
                const normal_number = normalizeToInteger(vol, 0, VOL_METER_MAX);

                if (user_box == undefined) {
                    return;
                }

                const animal_image =
                    user_box.getElementsByClassName("animal-image")[0];

                const animal = animal_image.alt;

                const url = new URL(animal_image.src);
                const filteredSrcPath = url.pathname.substring(1);

                if (user_box) {
                    if (normal_number > 1) {
                        user_box.style.boxShadow =
                            "0 0px 16px rgba(51, 204, 51, 1)";
                        if (filteredSrcPath == animalImages[animal].neutral) {
                            animal_image.src = animalImages[animal].talk;
                        }
                    } else {
                        user_box.style.boxShadow =
                            "0 4px 8px rgba(0, 0, 0, 0.1)";
                        if (filteredSrcPath == animalImages[animal].talk) {
                            animal_image.src = animalImages[animal].neutral;
                        }
                    }
                }
            }

            function normalizeToInteger(volume, min, max) {
                const scaledValue = Math.min(
                    max,
                    Math.max(min, volume * (max - min) + min)
                );
                return Math.round(scaledValue);
            }

            function addUser(userId, name, micStatus, animal = "dog") {
                if (document.getElementById(userId)) return;

                const userBox = document.createElement("div");
                userBox.id = userId;
                userBox.className = "user-box";
                userBox.innerHTML = `
                    <img src="${
                        animalImages[animal].neutral
                    }" alt="${animal}" class="animal-image"/>
                    <p class="name-box">${name}</p>
                    <div class="status-box">
                        <p class="mic-status">
                            <img src="${
                                micStatus ? "mic_on.png" : "mic_off.png"
                            }" alt="Mic Status" />
                        </p>
                        <p class="ready-status">
                            <img src="icons/notcheckIcon.png" alt="Ready Status"/>
                        </p>
                        <p class="me-handson">üò∂</p>
                    </div>

                    <button class="pick-button" onclick="selectFeedback(this.parentElement)">‚úì</button>
                    <audio id="audio-${userId}" autoplay></audio>
                    `;
                userContainer.appendChild(userBox);
            }

            function removeUser(userId) {
                const userBox = document.getElementById(userId);
                if (userBox) {
                    userContainer.removeChild(userBox);
                }
                closePeerConnection(userId);
            }

            function changeExpression(expression) {
                socket.emit("changeExpression", {
                    roomCode: roomCode,
                    expression: expression,
                    userId: socket.id,
                    animal: selectedAnimal, // ÏÑ†ÌÉùÌïú ÎèôÎ¨º Ï†ïÎ≥¥Î•º Ìï®Íªò Ï†ÑÏÜ°
                });

                console.log("Changing Expression!");

                if (timeoutId) {
                    clearTimeout(timeoutId);
                }

                timeoutId = setTimeout(() => {
                    socket.emit("changeExpression", {
                        roomCode,
                        expression: "neutral",
                        userId: socket.id,
                        animal: selectedAnimal, // ÏÑ†ÌÉùÌïú ÎèôÎ¨º Ï†ïÎ≥¥Î•º Ìï®Íªò Ï†ÑÏÜ°
                    });
                }, 4000);
            }

            function handsOnSign() {
                handsOn = !handsOn;

                socket.emit("handsOnSign", {
                    roomCode: roomCode,
                    userId: socket.id,
                    handsOn: handsOn,
                });
            }

            function updateExpression(data) {
                console.log("updating expression!!");
                const userBox = document.getElementById(data.userId);
                if (userBox) {
                    const animalImage = userBox.querySelector(".animal-image");
                    const images = animalImages[data.animal]; // ÏÇ¨Ïö©ÏûêÏùò ÏÑ†ÌÉùÎêú ÎèôÎ¨ºÏóê Îî∞Î•∏ Ïù¥ÎØ∏ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
                    switch (data.expression) {
                        case "happy":
                            animalImage.src = images.happy;
                            break;
                        case "sad":
                            animalImage.src = images.sad;
                            break;
                        case "surprised":
                            animalImage.src = images.surprised;
                            break;
                        case "neutral":
                        default:
                            animalImage.src = images.neutral;
                            break;
                    }
                }
            }

            function syncState(userId) {
                socket.emit("syncState", {
                    to: userId,
                    from: socket.id,
                    isMicOn: isMicOn,
                    isReady: isReady,
                });
            }

            function toggleReady() {
                isReady = !isReady;
                socket.emit("toggleReady", {
                    roomCode,
                    isReady,
                    userId: socket.id,
                });
            }

            function toggleMic() {
                if (!unmutable && !isMicOn) {
                    // mute ÏÉÅÌÉúÏóêÏÑúÎäî ÏºúÏßÄ Î™ªÌïòÍ≤å
                    return;
                }

                isMicOn = !isMicOn;
                socket.emit("toggleMic", {
                    roomCode,
                    isMicOn,
                    userId: socket.id,
                });

                const userBox = document.getElementById(socket.id);
                if (userBox) {
                    const micStatus = userBox.querySelector(".mic-status");
                    micStatus.innerHTML = `<img src="${
                        isMicOn ? "mic_on.png" : "mic_off.png"
                    }" alt="Mic Status">`;
                }

                console.log("Mic is " + (isMicOn ? "on" : "off"));

                // Enable or disable the audio tracks
                if (localStream) {
                    localStream.getAudioTracks().forEach((track) => {
                        track.enabled = isMicOn;
                    });

                    if (isMicOn) {
                        onFrameId = window.requestAnimationFrame(onFrame);
                    } else {
                        if (onFrameId) window.cancelAnimationFrame(onFrameId);
                    }
                } else {
                    console.error("No local stream available to toggle.");
                }
            }

            function createOffer(userId) {
                console.log("Creating... Offer...");

                const peerConnection = new RTCPeerConnection(config);
                peerConnections[userId] = peerConnection;

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log(
                            "offer emiting candiate to (" +
                                userId +
                                ") - " +
                                event.candidate
                        );
                        socket.emit("candidate", {
                            to: userId,
                            from: socket.id,
                            candidate: event.candidate,
                        });
                    }
                };

                peerConnection.ontrack = peerConnection.ontrack = (event) => {
                    handleAudioStream(event, userId); // Ïó¨Í∏∞ÏÑú handleAudioStream Ìï®Ïàò ÏÇ¨Ïö©
                };

                if (localStream) {
                    localStream.getTracks().forEach((track) => {
                        peerConnection.addTrack(track, localStream);
                    });
                }

                peerConnection
                    .createOffer()
                    .then((offer) => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        socket.emit("offer", {
                            to: userId,
                            from: socket.id,
                            offer: peerConnection.localDescription,
                        });
                    })
                    .catch((error) => {
                        console.error("Error creating offer: ", error);
                    });
            }

            function createAnswer(data) {
                console.log("Creating... Answer...");

                const peerConnection = new RTCPeerConnection(config);
                peerConnections[data.from] = peerConnection;

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log("Answer ice candidate : ");
                        console.log(event.candidate);
                        socket.emit("candidate", {
                            to: data.from,
                            from: socket.id,
                            candidate: event.candidate,
                        });
                    }
                };

                peerConnection.ontrack = peerConnection.ontrack = (event) => {
                    handleAudioStream(event, data.from); // Ïó¨Í∏∞ÏÑú handleAudioStream Ìï®Ïàò ÏÇ¨Ïö©
                };

                peerConnection
                    .setRemoteDescription(new RTCSessionDescription(data.offer))
                    .then(() => {
                        console.log("Remote description set.");
                        if (localStream) {
                            localStream.getTracks().forEach((track) => {
                                peerConnection.addTrack(track, localStream);
                            });
                        }
                        return peerConnection.createAnswer();
                    })
                    .then((answer) =>
                        peerConnection.setLocalDescription(answer)
                    )
                    .then(() => {
                        socket.emit("answer", {
                            to: data.from,
                            from: socket.id,
                            answer: peerConnection.localDescription,
                        });
                    })
                    .catch((error) => {
                        console.error("Error creating answer: ", error);
                    });
            }

            function closePeerConnection(userId) {
                if (peerConnections[userId]) {
                    peerConnections[userId].close();
                    delete peerConnections[userId];
                }
            }

            function handleAudioStream(event, userId) {
                const audio = document.querySelector(`#audio-${userId}`);

                if (audio) {
                    if (audio.srcObject !== event.streams[0]) {
                        audio.srcObject = event.streams[0];
                        console.log(
                            "Audio stream registered for user: " + userId
                        );

                        // ÏÜåÎ¶¨ ÌÅ¨Í∏∞ Î∂ÑÏÑùÏùÑ ÏúÑÌïú AudioContext ÏÑ§Ï†ï
                        const context = new AudioContext();
                        const analyzer = context.createAnalyser();
                        const mediaStreamSource =
                            context.createMediaStreamSource(event.streams[0]);
                        mediaStreamSource.connect(analyzer);
                        const pcmData = new Float32Array(analyzer.fftSize);

                        // ÏÉÅÎåÄÎ∞©Ïùò ÏÜåÎ¶¨ ÌÅ¨Í∏∞Ïóê Îî∞Îùº Ï¥àÎ°ù ÌÖåÎëêÎ¶¨ ÌëúÏãú
                        const userBox = document.getElementById(userId);
                        const analyzeAudio = () => {
                            analyzer.getFloatTimeDomainData(pcmData);
                            let sum = 0.0;
                            for (const amplitude of pcmData) {
                                sum += amplitude * amplitude;
                            }
                            const rms = Math.sqrt(sum / pcmData.length);
                            const normalizedVolume = Math.min(1, rms / 0.5);

                            changeVolumeColor(normalizedVolume * 10, userId);

                            requestAnimationFrame(analyzeAudio);
                        };
                        analyzeAudio(); // Î∂ÑÏÑù Ìï®Ïàò Ìò∏Ï∂ú
                    }
                } else {
                    console.error(`Audio element not found for user ${userId}`);
                }
            }

            // ------ Chat System ------
            let unreadMessages = 0;
            let chatWindowVisible = false;

            function toggleChatWindow() {
                if (chatWindowVisible) {
                    chatPopup.style.bottom = "-600px";
                    chatWindowVisible = false;
                } else {
                    chatPopup.style.bottom = "20px";
                    chatWindowVisible = true;
                    resetNotification();
                }
            }

            function resetNotification() {
                unreadMessages = 0;
                document.getElementById("chatNotification").textContent =
                    unreadMessages;
                document.getElementById("chatNotification").style.display =
                    "none";
            }

            function sendMessage() {
                const chatInput = document.getElementById("chatInput");
                const message = chatInput.value.trim();

                if (message !== "") {
                    const chatBody = document.getElementById("chatBody");

                    // send message to room
                    socket.emit("roomMessage", {
                        userId: socket.id,
                        roomCode: roomCode,
                        userName: userName,
                        message: message,
                        animal: selectedAnimal,
                    });
                    //addMessageToChat(message, userName, selectedAnimal);
                    chatInput.value = "";
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            }

            // Simulate receiving a message
            function receiveMessage(message, userName, animal) {
                addMessageToChat(message, userName, animal);

                if (!chatWindowVisible) {
                    unreadMessages++;
                    document.getElementById("chatNotification").textContent =
                        unreadMessages;
                    document.getElementById("chatNotification").style.display =
                        "flex";
                } else {
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            }

            function addMessageToChat(message, nickname, animal) {
                const chatBody = document.getElementById("chatBody");
                const messageElement = document.createElement("div");
                messageElement.className += "messageElement";
                messageElement.innerHTML = `<div style="display:flex; flex-direction: row; width: fit-content; items-align:center;"><img src='${animalImages[animal].neutral}' alt='animal image' width='24px'/><div style="display:flex; justify-content: center; align-items: center; margin-left:5px;"><b>${nickname}</b></div></div><div style="text-align:start; white-space:normal; word-wrap:break-word;">${message}<div/><hr/>`;
                chatBody.appendChild(messageElement);
            }
            // ----- Chat System Ends -----

            // ----- Sound Effect ------
            function dingSoundEffect() {
                const audio = document.getElementById("dingAudio");
                audio.volume = 0.3;
                audio.currentTime = 0;
                audio.play();
            }
            // ----- Sound Effect Ends -----

            // -------- Room Enter -------
            function joinRoom1() {
                disableAllJoinButton();
                tryJoinRoom("room_1");
            }

            function joinRoom2() {
                disableAllJoinButton();
                tryJoinRoom("room_2");
            }

            function joinRoom3() {
                disableAllJoinButton();
                tryJoinRoom("room_3");
            }

            function joinRoom4() {
                disableAllJoinButton();
                tryJoinRoom("room_4");
            }

            function joinRoom5() {
                disableAllJoinButton();
                tryJoinRoom("room_5");
            }

            function joinRoom6() {
                disableAllJoinButton();
                tryJoinRoom("room_6");
            }

            function joinRoom7() {
                disableAllJoinButton();
                tryJoinRoom("room_7");
            }

            function joinRoom8() {
                disableAllJoinButton();
                tryJoinRoom("room_8");
            }

            function disableAllJoinButton() {
                joinButton1.disabled = true;
                joinButton2.disabled = true;
                joinButton3.disabled = true;
                joinButton4.disabled = true;
                joinButton5.disabled = true;
                joinButton6.disabled = true;
                joinButton7.disabled = true;
                joinButton8.disabled = true;
            }

            function enableAllJoinButton() {
                joinButton1.disabled = false;
                joinButton2.disabled = false;
                joinButton3.disabled = false;
                joinButton4.disabled = false;
                joinButton5.disabled = false;
                joinButton6.disabled = false;
                joinButton7.disabled = false;
                joinButton8.disabled = false;
            }
            // ----- Room Enter Ends -----

            function requestRoomStatus() {
                console.log("Requesting room status...");
                socket.emit("roomStatus");
            }

            requestRoomStatus();
        </script>
    </body>
</html>
