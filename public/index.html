<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <!--<meta name="viewport" content="width=device-width, initial-scale=1.0" />-->
        <meta
            name="viewport"
            content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
        <title>Animon</title>
        <style>
            :root {
                --arrow-bg: rgba(255, 255, 255, 0.3);
                --arrow-icon: url(https://upload.wikimedia.org/wikipedia/commons/9/9d/Caret_down_font_awesome_whitevariation.svg);
                --option-bg: white;
                --select-bg: rgba(255, 255, 255, 0.2);
            }

            html {
                -ms-touch-action: manipulation;
                touch-action: manipulation;
            }

            button,
            input[type="button"],
            input[type="submit"] {
                -webkit-user-select: none; /* Chrome, Safari, Opera */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                user-select: none; /* Non-prefixed version, currently supported by most browsers */
                -webkit-tap-highlight-color: transparent; /* Removes highlight on tap in mobile browsers */
            }

            /* Ïä§ÌÉÄÏùº Î∂ÄÎ∂ÑÏùÄ Í∏∞Ï°¥Í≥º ÎèôÏùºÌï©ÎãàÎã§. */
            body {
                font-family: Arial, sans-serif;
                background-color: #f0f8ff;
                background-image: url("background_forest.png");
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-attachment: fixed;
                color: #333;
                display: flex;
                flex-direction: column;
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden;
                justify-content: center;
                align-items: center;
            }

            h1 {
                margin-bottom: 10px;
                color: #2c3e50;
                text-align: center;
            }

            form {
                margin-bottom: 20px;
            }

            input[type="text"] {
                padding: 10px;
                border: 1px solid #bdc3c7;
                border-radius: 5px;
                margin-right: 10px;
                width: 200px;
            }

            button {
                padding: 10px 20px;
                background-color: #e4a565;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s ease;
                width: 130px; /* Î≤ÑÌäº ÎÑàÎπÑÎ•º Í∑†ÏùºÌïòÍ≤å ÏÑ§Ï†ï */
                box-sizing: border-box; /* Ìå®Îî©Í≥º Î≥¥ÎçîÎ•º ÎÑàÎπÑÏóê Ìè¨Ìï® */
            }

            button:hover {
                background-color: #de9d5c;
            }

            #animalContainer {
                display: none;
                flex-direction: column;
                align-items: center;
            }

            .user-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }

            .user-counter {
                margin-bottom: 10px;
                font-size: x-large;
                font-weight: bolder;
                color: #2c3e50;
            }

            .user-box {
                display: flex;
                flex-direction: column;
                align-items: center;
                border: 1px solid #bdc3c7;
                border-radius: 25px;
                margin: 8px;
                padding: 8px;
                width: 120px;
                text-align: center;
                background-color: white;
                background-image: url("namecard_back.png");
                background-size: cover;
                background-position-x: 25%;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .animal-image {
                width: 120px;
                height: 120px;
                border-radius: 60px;
            }

            .expression-buttons {
                display: flex;
                margin-top: 20px;
            }

            .expression-buttons button,
            .mic-button button {
                margin: 5px;
                flex-grow: 1;
            }

            .tool-buttons {
                display: flex;
                margin-top: 5px;
            }

            .mic-button {
                display: flex;
                justify-content: center;
            }

            .ready-button {
                display: flex;
                justify-content: center;
            }

            .ready-button button {
                margin: 5px;
            }

            .ready-status {
                margin-top: 4px;
                margin-bottom: 8px;
            }

            .ready-status img {
                width: 24px;
                height: 24px;
                vertical-align: middle;
            }

            .mic-status {
                margin-top: 8px;
                margin-bottom: 4px;
            }

            .mic-status img {
                width: 20px;
                height: 20px;
                background-color: white;
                padding: 4px;
                border-radius: 10px;
                vertical-align: middle;
            }

            .name-box {
                margin-top: 8px;
                margin-bottom: 8px;
                background-color: white;
                border-radius: 0.2rem;
                padding: 5px;
                padding-left: 10px;
                padding-right: 10px;
                width: fit-content;
            }

            .notice-box {
                margin-top: 8px;
                margin-bottom: 8px;
                margin-bottom: 10px;
                font-size: x-large;
                font-weight: bolder;
                color: #ff6666;
                background-color: white;
                padding: 5px 10px 5px 10px;
                border-radius: 0.2rem;
                display: none;
            }

            .intro-form {
                display: flex;
                flex-direction: column;
                flex-wrap: nowrap;
                align-items: center;
                gap: 10px;
            }

            .room-code-form {
                display: none;
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .transparent-box {
                border: 1px solid #abc8db;
                border-radius: 25px;
                padding: 15px;
                margin: 20px;
                margin-top: 30px;
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                box-shadow: 2px 7px 15px 8px rgba(0, 0, 0, 0.3);
            }

            select {
                /* Reset */
                appearance: none;
                border: 0;
                outline: 0;
                font: inherit;
                /* Personalize */
                width: 10rem;
                padding: 0.5rem 2rem 0.5rem 2rem;
                background: var(--arrow-icon) no-repeat right 0.8em center /
                        1.4em,
                    linear-gradient(
                        to left,
                        var(--arrow-bg) 3em,
                        var(--select-bg) 3em
                    );
                color: white;
                border-radius: 0.25em;
                box-shadow: 0 0 1em 0 rgba(0, 0, 0, 0.2);
                cursor: pointer;
                /* Remove IE arrow */
                &::-ms-expand {
                    display: none;
                }
                /* Remove focus outline */
                &:focus {
                    outline: none;
                }
                /* <option> colors */
                option {
                    color: inherit;
                    background-color: var(--option-bg);
                }
            }

            .form__group {
                position: relative;
                padding: 15px 0 0;
                margin-top: 10px;
                width: 50%;
            }

            .form__field {
                font-family: inherit;
                width: 100%;
                border: 0;
                border-bottom: 2px solid white;
                outline: 0;
                font-size: 1.3rem;
                color: white;
                padding: 7px 0;
                background: transparent;
                transition: border-color 0.2s;

                &::placeholder {
                    color: transparent;
                }

                &:placeholder-shown ~ .form__label {
                    font-size: 1.3rem;
                    cursor: text;
                    top: 20px;
                }
            }

            .form__label {
                position: absolute;
                top: 0;
                display: block;
                transition: 0.2s;
                font-size: 1rem;
                color: white;
            }

            .form__field:focus {
                ~ .form__label {
                    position: absolute;
                    top: 0;
                    display: block;
                    transition: 0.2s;
                    font-size: 1rem;
                    color: #ff9c22;
                    font-weight: 700;
                }
                padding-bottom: 6px;
                font-weight: 700;
                border-width: 3px;
                border-image: linear-gradient(to right, #ff9c22, #dacfc4);
                border-image-slice: 1;
            }
            /* reset input */
            .form__field {
                &:required,
                &:invalid {
                    box-shadow: none;
                }
            }

            /* --------- Chat System ---------*/
            /* Floating Button */
            .chat-float-btn {
                display: none;
                position: fixed;
                right: 20px;
                bottom: 20px;
                background-color: #e4a565;
                color: white;
                padding: 15px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 24px;
                width: 2rem;
                height: 2rem;
                text-align: center;
                justify-content: center;
                box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            }

            /* Notification Badge */
            .chat-notification {
                position: absolute;
                top: 0px;
                right: 0px;
                background-color: red;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
            }

            /* Chat Popup Window */
            .chat-popup {
                position: fixed;
                bottom: -600px;
                right: 20px;
                width: 300px;
                background-color: white;
                border: 1px solid #e2872d;
                box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
                border-radius: 10px;
                transition: bottom 0.3s;
                text-align: center;
                justify-content: center;
            }

            /* Chat Header */
            .chat-header {
                padding: 10px;
                background-color: #e4a565;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
                height: 2rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .chat-header button {
                flex-basis: content;
                font-size: medium;
            }

            .chat-header h4 {
                margin-left: 0.3rem;
                color: white;
            }

            /* Chat Body */
            .chat-body {
                max-height: 400px;
                min-height: 200px;
                overflow-y: auto;
                padding: 10px;
                background-color: #ffffff;
            }

            /* Chat Input */
            .chat-input {
                display: flex;
                border-top: 1px solid #ccc;
            }

            .chat-input input {
                flex-grow: 1;
                padding: 10px;
                border: none;
                border-bottom-left-radius: 10px;
            }

            .chat-input button {
                padding: 10px;
                background-color: #e4a565;
                color: white;
                border: none;
                border-bottom-right-radius: 10px;
                cursor: pointer;
            }

            .messageElement {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            /* --------- Chat System Ends ---------*/
        </style>
    </head>
    <body>
        <div id="transparentBox" class="transparent-box">
            <h1>Animon</h1>
            <form id="nameForm" class="intro-form">
                <img
                    src="images/intro.jpeg"
                    width="400px"
                    style="border-radius: 30px" />

                <div class="form__group field" style="margin-bottom: 5px">
                    <input
                        type="input"
                        id="userName"
                        name="userName"
                        class="form__field"
                        placeholder="Enter Your Name"
                        required />
                    <label for="userName" class="form__label">Name</label>
                </div>

                <select id="animalChoice">
                    <option value="dog">Dog</option>
                    <option value="cat">Cat</option>
                    <option value="squirrel">Squirrel</option>
                    <option value="fox">Fox</option>
                    <option value="panda">Panda</option>
                </select>
                <button type="submit">Join</button>
            </form>
            <form id="roomForm" class="room-code-form">
                <img
                    src="images/intro.jpeg"
                    width="400px"
                    style="border-radius: 30px" />

                <div class="form__group field" style="margin-bottom: 5px">
                    <input
                        type="input"
                        id="roomCode"
                        name="roomCode"
                        class="form__field"
                        placeholder="Enter Room Code"
                        required />
                    <label for="roomCode" class="form__label">Room Code</label>
                </div>
                <button type="submit">Join Room</button>
            </form>
            <div id="animalContainer">
                <div id="noticeBox" class="notice-box">NOTICE :</div>

                <div id="userCounter" class="user-counter">1 / 5</div>
                <div id="userContainer" class="user-container"></div>
                <div class="expression-buttons">
                    <button onclick="changeExpression('happy')">
                        üòä Happy
                    </button>
                    <button onclick="changeExpression('sad')">üò¢ Sad</button>
                    <button onclick="changeExpression('surprised')">
                        üò≤ Surprised
                    </button>
                </div>
                <div class="tool-buttons">
                    <div class="mic-button">
                        <button onclick="toggleMic()">üé§ Toggle Mic</button>
                    </div>
                    <div class="ready-button">
                        <button onclick="toggleReady()">‚úÖ Ready</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Button -->
        <div
            id="chatFloatButton"
            class="chat-float-btn"
            onclick="toggleChatWindow()"
            style="
                -webkit-user-select: none; /* Chrome, Safari, Opera */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                user-select: none; /* Non-prefixed version, currently supported by most browsers */
                -webkit-tap-highlight-color: transparent;
            ">
            üí¨
            <div
                class="chat-notification"
                id="chatNotification"
                style="display: none">
                0
            </div>
        </div>

        <!-- Chat Popup Window -->
        <div class="chat-popup" id="chatPopup">
            <div class="chat-header">
                <h4>Room Chat</h4>
                <button onclick="toggleChatWindow()">‚úñ</button>
            </div>
            <div class="chat-body" id="chatBody">
                <!-- Messages will be appended here -->
            </div>
            <div class="chat-input">
                <input
                    type="text"
                    id="chatInput"
                    placeholder="Type a message..." />
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();

            const nameForm = document.getElementById("nameForm");
            const roomForm = document.getElementById("roomForm");
            const animalContainer = document.getElementById("animalContainer");
            const userContainer = document.getElementById("userContainer");
            const userCounter = document.getElementById("userCounter");
            const noticeBox = document.getElementById("noticeBox");
            const chatFloatButton = document.getElementById("chatFloatButton");
            const chatPopup = document.getElementById("chatPopup");

            let isMicOn = false;
            let roomCode = null;
            let userName = "";
            let timeoutId = null;
            let localStream = null;
            let onFrameId = null;
            let onFrame;
            let userCount = 0;
            let selectedAnimal = "dog"; // Í∏∞Î≥∏ Í∞íÏúºÎ°ú ÏÑ§Ï†ï

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§ÌñâÎê† ÏΩîÎìú
            window.onload = function () {
                const animalSelect = document.getElementById("animalChoice");
                const options = animalSelect.options;
                const randomIndex = Math.floor(Math.random() * options.length);
                animalSelect.selectedIndex = randomIndex; // ÎûúÎç§ÌïòÍ≤å ÏÑ†ÌÉùÎêú ÏòµÏÖò Ïù∏Îç±Ïä§Î•º ÏÑ§Ï†ï
            };

            // Î∞© ÏãúÏûë Ï§ÄÎπÑ ÌôïÏù∏
            let isReady = false;

            const peerConnections = {};
            const config = {
                iceServers: [
                    { urls: "stun:stun.l.google.com:19302" },
                    {
                        urls: "turn:141.164.63.143",
                        username: "animon",
                        credential: "animon",
                    },
                ],
            };

            // ÎèôÎ¨º Î¶¨Ïä§Ìä∏
            const animalImages = {
                dog: {
                    neutral: "images/dog_neutral.png",
                    happy: "images/dog_happy.png",
                    sad: "images/dog_sad.png",
                    surprised: "images/dog_surprised.png",
                },
                cat: {
                    neutral: "images/cat_neutral.png",
                    happy: "images/cat_happy.png",
                    sad: "images/cat_sad.png",
                    surprised: "images/cat_surprised.png",
                },
                squirrel: {
                    neutral: "images/squirrel_neutral.png",
                    happy: "images/squirrel_happy.png",
                    sad: "images/squirrel_sad.png",
                    surprised: "images/squirrel_surprised.png",
                },
                fox: {
                    neutral: "images/fox_neutral.png",
                    happy: "images/fox_happy.png",
                    sad: "images/fox_sad.png",
                    surprised: "images/fox_surprised.png",
                },
                panda: {
                    neutral: "images/panda_neutral.png",
                    happy: "images/panda_happy.png",
                    sad: "images/panda_sad.png",
                    surprised: "images/panda_surprised.png",
                },
            };

            nameForm.addEventListener("submit", (e) => {
                e.preventDefault();
                userName = document.getElementById("userName").value;
                selectedAnimal = document.getElementById("animalChoice").value; // ÏÑ†ÌÉùÎêú ÎèôÎ¨º Ï†ÄÏû•
                nameForm.style.display = "none";
                roomForm.style.display = "flex";
            });

            roomForm.addEventListener("submit", (e) => {
                e.preventDefault();
                roomCode = document.getElementById("roomCode").value;
                tryJoinRoom(roomCode);
            });

            function tryJoinRoom(roomCode) {
                socket.emit("tryJoin", roomCode);
            }

            socket.on("roomFull", () => {
                alert("Room is full!");
            });

            socket.on("joinOK", (roomCode) => {
                joinRoom(roomCode);
            });

            async function joinRoom(roomCode) {
                console.log("Accessing media...");
                // ÎßàÏù¥ÌÅ¨ Ïä§Ìä∏Î¶º ÏÑ§Ï†ï
                await navigator.mediaDevices
                    .getUserMedia({ audio: true })
                    .then((stream) => {
                        localStream = stream; // Î°úÏª¨ Ïä§Ìä∏Î¶º Ï†ÄÏû•
                        console.log("Local stream obtained");

                        // Ìä∏Îûô ÎπÑÌôúÏÑ±Ìôî
                        localStream.getAudioTracks().forEach((track) => {
                            track.enabled = false;
                        });

                        // ÎßàÏù¥ÌÅ¨ Ïù∏Ìíã Ï∏°Ï†ï
                        const context = new AudioContext();
                        const analyzer = context.createAnalyser();
                        const mediaStreamAudioStreamSource =
                            context.createMediaStreamSource(stream);
                        mediaStreamAudioStreamSource.connect(analyzer, 0);
                        const pcmData = new Float32Array(analyzer.fftSize);

                        // register anim
                        onFrame = () => {
                            analyzer.getFloatTimeDomainData(pcmData);
                            let sum = 0.0;
                            for (const amplitude of pcmData) {
                                sum += amplitude * amplitude;
                            }
                            const rms = Math.sqrt(sum / pcmData.length);
                            const normalizedVolume = Math.min(1, rms / 0.5);
                            changeVolumeColor(normalizedVolume * 10);
                            onFrameId = window.requestAnimationFrame(onFrame);
                        };

                        onFrameId = window.requestAnimationFrame(onFrame);
                    })
                    .catch((error) => {
                        console.error("Error accessing media devices.", error);
                    });

                //Î£∏ Ï°∞Ïù∏
                socket.emit("joinRoom", {
                    roomCode,
                    userName,
                    animal: selectedAnimal,
                });
                roomForm.style.display = "none";
                chatFloatButton.style.display = "block";

                animalContainer.style.display = "flex";

                socket.off("existingUsers");
                socket.off("userJoined");
                socket.off("userLeft");
                socket.off("changeExpression");
                socket.off("toggleMic");
                socket.off("toggleReady");
                socket.off("syncState");
                socket.off("offer");
                socket.off("answer");
                socket.off("candidate");
                socket.off("startSession");
                socket.off("roomMessage");

                console.log("My socket id : " + socket.id);

                socket.on("adminNotice", (notice_string) => {
                    noticeBox.innerText = "NOTICE : " + notice_string;
                });

                socket.on("existingUsers", (users) => {
                    users.forEach((user) => {
                        addUser(
                            user.userId,
                            user.userName,
                            user.isMicOn,
                            user.animal
                        );
                        userCount++;
                    });
                    userCounter.innerText = userCount + " / 5";
                });

                socket.on("userJoined", (data) => {
                    if (data.userId == socket.id) {
                        console.log("user join conflict!");
                        return;
                    }

                    console.log(
                        "\n" +
                            data.userId +
                            " joined room " +
                            roomCode +
                            "!! \n\n"
                    );
                    addUser(
                        data.userId,
                        data.userName,
                        data.isMicOn,
                        data.animal
                    );
                    createOffer(data.userId);
                    syncState(data.userId);

                    userCount++;
                    userCounter.innerText = userCount + " / 5";
                });

                socket.on("userLeft", (data) => {
                    removeUser(data.userId);
                    closePeerConnection(data.userId);

                    console.log("User " + data.userId + " left voice room.");
                    userCount--;
                    userCounter.innerText = userCount + " / 5";
                });

                socket.on("changeExpression", (data) => {
                    updateExpression(data);
                });

                socket.on("toggleMic", (data) => {
                    const userBox = document.getElementById(data.userId);
                    if (userBox) {
                        const micStatus = userBox.querySelector(".mic-status");
                        micStatus.innerHTML = `<img src="${
                            data.isMicOn ? "mic_on.png" : "mic_off.png"
                        }" alt="Mic Status">`;
                    }
                    console.log(
                        `Mic for user ${data.userId} is ${
                            data.isMicOn ? "on" : "off"
                        }`
                    );
                });

                socket.on("toggleReady", (data) => {
                    const userBox = document.getElementById(data.userId);
                    if (userBox) {
                        const readyStatus =
                            userBox.querySelector(".ready-status");
                        readyStatus.innerHTML = `<img src="${
                            data.isReady
                                ? "icons/checkIcon.png"
                                : "icons/notcheckIcon.png"
                        }" alt="Ready Status">`;
                    }
                    console.log(
                        `Ready for user ${data.userId} is ${
                            data.isReady ? "ready" : "not ready"
                        }`
                    );
                });

                socket.on("offer", (data) => {
                    console.log("Recieve offer from.." + data.from);
                    createAnswer(data);
                });

                socket.on("answer", (data) => {
                    console.log("Recieve answer from.." + data.from);
                    if (peerConnections[data.from]) {
                        if (data.from == socket.id) {
                            console.log("Anwser self conflict!");
                            return;
                        }

                        peerConnections[data.from]
                            .setRemoteDescription(
                                new RTCSessionDescription(data.answer)
                            )
                            .catch((error) => {
                                console.error(
                                    "Error setting remote description for answer: ",
                                    error
                                );
                            });

                        console.log(
                            "Registering answer => from : " +
                                data.from +
                                " to : "
                        );
                        console.log(data.answer);
                    }
                });

                socket.on("candidate", (data) => {
                    const candidate = new RTCIceCandidate(data.candidate);
                    if (peerConnections[data.from]) {
                        console.log(
                            "Got candidate from " +
                                data.from +
                                " ... Registering."
                        );
                        peerConnections[data.from].addIceCandidate(candidate);
                    }
                });

                socket.on("syncState", (data) => {
                    console.log(
                        "Sync from other user (" + data.from + " starts."
                    );

                    const userBox = document.getElementById(data.from);
                    if (userBox) {
                        // Sync Mic Status
                        const micStatus = userBox.querySelector(".mic-status");
                        micStatus.innerHTML = `<img src="${
                            data.isMicOn ? "mic_on.png" : "mic_off.png"
                        }" alt="Mic Status">`;

                        // Sync Ready Status
                        const readyStatus =
                            userBox.querySelector(".ready-status");
                        readyStatus.innerHTML = `<img src="${
                            data.isReady
                                ? "icons/checkIcon.png"
                                : "icons/notcheckIcon.png"
                        }" alt="Ready Status">`;
                    }
                });

                socket.on("startSession", () => {
                    alert("Session Starts!");
                });

                socket.on("roomMessage", (data) => {
                    // if (data.userId == socket.id) {
                    //     return;
                    // }

                    receiveMessage(data.message, data.userName, data.animal);
                });
            }

            function changeVolumeColor(vol, id = socket.id) {
                //console.log("Changing volume color base on => " + vol);

                const VOL_METER_MAX = 10;
                const user_box = document.getElementById(id);
                const normal_number = normalizeToInteger(vol, 0, VOL_METER_MAX);

                if (user_box) {
                    if (normal_number > 1)
                        user_box.style.boxShadow =
                            "0 0px 16px rgba(51, 204, 51, 1)";
                    else
                        user_box.style.boxShadow =
                            "0 4px 8px rgba(0, 0, 0, 0.1)";
                }
            }

            function normalizeToInteger(volume, min, max) {
                const scaledValue = Math.min(
                    max,
                    Math.max(min, volume * (max - min) + min)
                );
                return Math.round(scaledValue);
            }

            function addUser(userId, name, micStatus, animal = "dog") {
                if (document.getElementById(userId)) return;

                const userBox = document.createElement("div");
                userBox.id = userId;
                userBox.className = "user-box";
                userBox.innerHTML = `
                    <img src="${
                        animalImages[animal].neutral
                    }" alt="Animal Character" class="animal-image">
                    <p class="name-box">${name}</p>
                    <p class="mic-status"><img src="${
                        micStatus ? "mic_on.png" : "mic_off.png"
                    }" alt="Mic Status"></p>
                    <p class="ready-status"><img src="icons/notcheckIcon.png" alt="Ready Status"></p>
                    <audio id="audio-${userId}" autoplay></audio>
                    `;
                userContainer.appendChild(userBox);
            }

            function removeUser(userId) {
                const userBox = document.getElementById(userId);
                if (userBox) {
                    userContainer.removeChild(userBox);
                }
                closePeerConnection(userId);
            }

            function changeExpression(expression) {
                socket.emit("changeExpression", {
                    roomCode,
                    expression,
                    userId: socket.id,
                    animal: selectedAnimal, // ÏÑ†ÌÉùÌïú ÎèôÎ¨º Ï†ïÎ≥¥Î•º Ìï®Íªò Ï†ÑÏÜ°
                });

                if (timeoutId) {
                    clearTimeout(timeoutId);
                }

                timeoutId = setTimeout(() => {
                    socket.emit("changeExpression", {
                        roomCode,
                        expression: "neutral",
                        userId: socket.id,
                        animal: selectedAnimal, // ÏÑ†ÌÉùÌïú ÎèôÎ¨º Ï†ïÎ≥¥Î•º Ìï®Íªò Ï†ÑÏÜ°
                    });
                }, 2000);
            }

            function updateExpression(data) {
                const userBox = document.getElementById(data.userId);
                if (userBox) {
                    const animalImage = userBox.querySelector(".animal-image");
                    const images = animalImages[data.animal]; // ÏÇ¨Ïö©ÏûêÏùò ÏÑ†ÌÉùÎêú ÎèôÎ¨ºÏóê Îî∞Î•∏ Ïù¥ÎØ∏ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
                    switch (data.expression) {
                        case "happy":
                            animalImage.src = images.happy;
                            break;
                        case "sad":
                            animalImage.src = images.sad;
                            break;
                        case "surprised":
                            animalImage.src = images.surprised;
                            break;
                        case "neutral":
                        default:
                            animalImage.src = images.neutral;
                            break;
                    }
                }
            }

            function syncState(userId) {
                socket.emit("syncState", {
                    to: userId,
                    from: socket.id,
                    isMicOn: isMicOn,
                    isReady: isReady,
                });
            }

            function toggleReady() {
                isReady = !isReady;
                socket.emit("toggleReady", {
                    roomCode,
                    isReady,
                    userId: socket.id,
                });
            }

            function toggleMic() {
                isMicOn = !isMicOn;
                socket.emit("toggleMic", {
                    roomCode,
                    isMicOn,
                    userId: socket.id,
                });

                const userBox = document.getElementById(socket.id);
                if (userBox) {
                    const micStatus = userBox.querySelector(".mic-status");
                    micStatus.innerHTML = `<img src="${
                        isMicOn ? "mic_on.png" : "mic_off.png"
                    }" alt="Mic Status">`;
                }

                console.log("Mic is " + (isMicOn ? "on" : "off"));

                // Enable or disable the audio tracks
                if (localStream) {
                    localStream.getAudioTracks().forEach((track) => {
                        track.enabled = isMicOn;
                    });

                    if (isMicOn) {
                        onFrameId = window.requestAnimationFrame(onFrame);
                    } else {
                        if (onFrameId) window.cancelAnimationFrame(onFrameId);
                    }
                } else {
                    console.error("No local stream available to toggle.");
                }
            }

            function createOffer(userId) {
                console.log("Creating... Offer...");

                const peerConnection = new RTCPeerConnection(config);
                peerConnections[userId] = peerConnection;

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log(
                            "offer emiting candiate to (" +
                                userId +
                                ") - " +
                                event.candidate
                        );
                        socket.emit("candidate", {
                            to: userId,
                            from: socket.id,
                            candidate: event.candidate,
                        });
                    }
                };

                peerConnection.ontrack = peerConnection.ontrack = (event) => {
                    handleAudioStream(event, userId); // Ïó¨Í∏∞ÏÑú handleAudioStream Ìï®Ïàò ÏÇ¨Ïö©
                };

                if (localStream) {
                    localStream.getTracks().forEach((track) => {
                        peerConnection.addTrack(track, localStream);
                    });
                }

                peerConnection
                    .createOffer()
                    .then((offer) => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        socket.emit("offer", {
                            to: userId,
                            from: socket.id,
                            offer: peerConnection.localDescription,
                        });
                    })
                    .catch((error) => {
                        console.error("Error creating offer: ", error);
                    });
            }

            function createAnswer(data) {
                console.log("Creating... Answer...");

                const peerConnection = new RTCPeerConnection(config);
                peerConnections[data.from] = peerConnection;

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log("Answer ice candidate : ");
                        console.log(event.candidate);
                        socket.emit("candidate", {
                            to: data.from,
                            from: socket.id,
                            candidate: event.candidate,
                        });
                    }
                };

                peerConnection.ontrack = peerConnection.ontrack = (event) => {
                    handleAudioStream(event, data.from); // Ïó¨Í∏∞ÏÑú handleAudioStream Ìï®Ïàò ÏÇ¨Ïö©
                };

                peerConnection
                    .setRemoteDescription(new RTCSessionDescription(data.offer))
                    .then(() => {
                        console.log("Remote description set.");
                        if (localStream) {
                            localStream.getTracks().forEach((track) => {
                                peerConnection.addTrack(track, localStream);
                            });
                        }
                        return peerConnection.createAnswer();
                    })
                    .then((answer) =>
                        peerConnection.setLocalDescription(answer)
                    )
                    .then(() => {
                        socket.emit("answer", {
                            to: data.from,
                            from: socket.id,
                            answer: peerConnection.localDescription,
                        });
                    })
                    .catch((error) => {
                        console.error("Error creating answer: ", error);
                    });
            }

            function closePeerConnection(userId) {
                if (peerConnections[userId]) {
                    peerConnections[userId].close();
                    delete peerConnections[userId];
                }
            }

            function handleAudioStream(event, userId) {
                const audio = document.querySelector(`#audio-${userId}`);

                if (audio) {
                    if (audio.srcObject !== event.streams[0]) {
                        audio.srcObject = event.streams[0];
                        console.log(
                            "Audio stream registered for user: " + userId
                        );

                        // ÏÜåÎ¶¨ ÌÅ¨Í∏∞ Î∂ÑÏÑùÏùÑ ÏúÑÌïú AudioContext ÏÑ§Ï†ï
                        const context = new AudioContext();
                        const analyzer = context.createAnalyser();
                        const mediaStreamSource =
                            context.createMediaStreamSource(event.streams[0]);
                        mediaStreamSource.connect(analyzer);
                        const pcmData = new Float32Array(analyzer.fftSize);

                        // ÏÉÅÎåÄÎ∞©Ïùò ÏÜåÎ¶¨ ÌÅ¨Í∏∞Ïóê Îî∞Îùº Ï¥àÎ°ù ÌÖåÎëêÎ¶¨ ÌëúÏãú
                        const userBox = document.getElementById(userId);
                        const analyzeAudio = () => {
                            analyzer.getFloatTimeDomainData(pcmData);
                            let sum = 0.0;
                            for (const amplitude of pcmData) {
                                sum += amplitude * amplitude;
                            }
                            const rms = Math.sqrt(sum / pcmData.length);
                            const normalizedVolume = Math.min(1, rms / 0.5);

                            changeVolumeColor(normalizedVolume * 10, userId);

                            requestAnimationFrame(analyzeAudio);
                        };
                        analyzeAudio(); // Î∂ÑÏÑù Ìï®Ïàò Ìò∏Ï∂ú
                    }
                } else {
                    console.error(`Audio element not found for user ${userId}`);
                }
            }

            // ------ Chat System ------
            let unreadMessages = 0;
            let chatWindowVisible = false;

            function toggleChatWindow() {
                if (chatWindowVisible) {
                    chatPopup.style.bottom = "-600px";
                    chatWindowVisible = false;
                } else {
                    chatPopup.style.bottom = "20px";
                    chatWindowVisible = true;
                    resetNotification();
                }
            }

            function resetNotification() {
                unreadMessages = 0;
                document.getElementById("chatNotification").textContent =
                    unreadMessages;
                document.getElementById("chatNotification").style.display =
                    "none";
            }

            function sendMessage() {
                const chatInput = document.getElementById("chatInput");
                const message = chatInput.value.trim();

                if (message !== "") {
                    const chatBody = document.getElementById("chatBody");

                    // send message to room
                    socket.emit("roomMessage", {
                        userId: socket.id,
                        roomCode: roomCode,
                        userName: userName,
                        message: message,
                        animal: selectedAnimal,
                    });
                    //addMessageToChat(message, userName, selectedAnimal);
                    chatInput.value = "";
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            }

            // Simulate receiving a message
            function receiveMessage(message, userName, animal) {
                addMessageToChat(message, userName, animal);

                if (!chatWindowVisible) {
                    unreadMessages++;
                    document.getElementById("chatNotification").textContent =
                        unreadMessages;
                    document.getElementById("chatNotification").style.display =
                        "flex";
                } else {
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            }

            function addMessageToChat(message, nickname, animal) {
                const chatBody = document.getElementById("chatBody");
                const messageElement = document.createElement("div");
                messageElement.className += "messageElement";
                messageElement.innerHTML = `<div style="display:flex; flex-direction: row; width: fit-content; items-align:center;"><img src='${animalImages[animal].neutral}' alt='animal image' width='24px'/><div style="display:flex; justify-content: center; align-items: center; margin-left:5px;"><b>${nickname}</b></div></div><div style="text-align:start; white-space:normal; word-wrap:break-word;">${message}<div/><hr/>`;
                chatBody.appendChild(messageElement);
            }
            // ----- Chat System Ends -----
        </script>
    </body>
</html>
